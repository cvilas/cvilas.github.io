<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Server.hpp Source File</title>
<link href="stylesheet.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Mon Apr 30 11:57:54 2001 -->
<h1>Server.hpp</h1><div class="fragment"><pre>00001 
00002 
00003 <font class="preprocessor">#ifndef _SERVER_HPP_INCLUDED</font>
00004 <font class="preprocessor"></font><font class="preprocessor">#define _SERVER_HPP_INCLUDED</font>
00005 <font class="preprocessor"></font>
00006 <font class="preprocessor">#include "QRTSBase.hpp"</font>
00007 
00008 <font class="preprocessor">#ifdef NTO</font>
00009 <font class="preprocessor"></font><font class="preprocessor">    #include &lt;sys/neutrino.h&gt;</font>
00010 <font class="preprocessor">    #include &lt;sys/dispatch.h&gt;</font>
00011 <font class="preprocessor">#else</font>
00012 <font class="preprocessor"></font><font class="preprocessor">    #include &lt;sys/kernel.h&gt;</font>
00013 <font class="preprocessor">#endif</font>
00014 <font class="preprocessor"></font>
00015 <font class="preprocessor">#include &lt;errno.h&gt;</font>
00016 <font class="preprocessor">#include &lt;string.h&gt;</font>
00017 
00018 
00039 <font class="keyword">class </font><a class="code" href="class_Server.html">Server</a> : <font class="keyword">public</font> QRTSBase
00040 {
00041   <font class="keyword">private</font>:
00042     <font class="keyword">enum</font> Constants
00043     {
00044         e_maxStatusMessageTextLength = 1024   
00045     };
00046 
00051   <font class="keyword">public</font>:
00052       <a class="code" href="class_Server.html#a0">Server</a> (<font class="keyword">const</font> <font class="keywordtype">char</font> *serverName = 0, <font class="keywordtype">int</font> maxMessageSize = 1024);
00069     <font class="keyword">virtual</font> <a class="code" href="class_Server.html#a1">~Server</a> ();
00073       <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a2">attachServerName</a> (<font class="keyword">const</font> <font class="keywordtype">char</font> *serverName);
00079     <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a3">detachServerName</a> ();
<a name="l00083"></a><a class="code" href="class_Server.html#a4">00083</a>     <font class="keyword">const</font> <font class="keywordtype">char</font> *<a class="code" href="class_Server.html#a4">getServerName</a> ()<font class="keyword"> const</font>
00084 <font class="keyword">        </font>{ <font class="keywordflow">return</font> d_serverName; }
00088 <font class="preprocessor">    #ifndef DOXYGEN   </font>
00089 <font class="preprocessor"></font><font class="preprocessor">    #ifdef NTO</font>
00090 <font class="preprocessor"></font>        <font class="keyword">typedef</font> <font class="keywordtype">int</font> ClientId;
00091 <font class="preprocessor">    #else</font>
00092 <font class="preprocessor"></font>        <font class="keyword">typedef</font> pid_t ClientId;
00093 <font class="preprocessor">    #endif</font>
00094 <font class="preprocessor"></font><font class="preprocessor">    #endif</font>
00095 <font class="preprocessor"></font>
00096   <font class="keyword">public</font>:
00097       <font class="keyword">virtual</font> <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a5">doMessageLoop</a> ();
00104     <font class="keyword">virtual</font> <font class="keywordtype">int</font> <a class="code" href="class_Server.html#a6">serveMessage</a> (pid_t pid, <font class="keywordtype">void</font> *messageBuffer);
00112     <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a8">replyMessage</a> (<font class="keyword">const</font> <font class="keywordtype">void</font> *reply, <font class="keywordtype">int</font> replySize);
00120     <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a8">replyMessage</a> ();
00126     <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a8">replyMessage</a> (<font class="keywordtype">int</font> iReply);
00133     <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a8">replyMessage</a> (Status &amp;status);
00144 <font class="keyword">public</font>:
00145     <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a12">receiveMessage</a>(<font class="keywordtype">void</font> *msg, <font class="keywordtype">int</font> msgSize);
00152     <font class="keywordtype">int</font> <a class="code" href="class_Server.html#a12">receiveMessage</a>();
00158     pid_t <a class="code" href="class_Server.html#a13">receiveMessageFromAnybody</a>(<font class="keywordtype">void</font> *message, <font class="keywordtype">int</font> messageSize);
00163 <font class="keyword">public</font>:
00164 <font class="preprocessor">    #ifndef DOXYGEN</font>
00165 <font class="preprocessor"></font>    
00166     <font class="keywordtype">void</font> setClientId (ClientId id)<font class="keyword"> </font>{ d_clientId = id; }
00172     ClientId getClientId ()<font class="keyword"> </font>{ <font class="keywordflow">return</font> d_clientId; }
00176 <font class="preprocessor">    #ifdef NTO</font>
00177 <font class="preprocessor"></font>        <font class="keywordtype">int</font> getChannelId()<font class="keyword"> </font>{ <font class="keywordflow">return</font> d_channelId; }
00180 <font class="preprocessor">  #endif</font>
00181 <font class="preprocessor"></font>    
00182 <font class="preprocessor">    #endif</font>
00183 <font class="preprocessor"></font>    
00184   <font class="keyword">private</font>:
00185       <font class="keyword">const</font> <font class="keywordtype">int</font> d_maxMessageSize;
00189     <font class="keywordtype">char</font> *d_messageBuffer;
00193     <font class="keywordtype">char</font> *d_serverName;
00197     ClientId d_clientId;
00203 <font class="preprocessor">  #ifdef NTO</font>
00204 <font class="preprocessor"></font>        name_attach_t *d_attach;
00205         <font class="keyword">public</font>:
00206         <font class="keywordtype">int</font> d_channelId;
00207 <font class="preprocessor">    #else</font>
00208 <font class="preprocessor"></font>        <font class="keywordtype">int</font> d_serverNameId;
00209 <font class="preprocessor">    #endif</font>
00210 <font class="preprocessor"></font>};
00211 
00212 
<a name="l00216"></a><a class="code" href="class_Server.html#a7">00216</a> <font class="keyword">inline</font> <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a8">Server::replyMessage</a>(<font class="keyword">const</font> <font class="keywordtype">void</font> *message, <font class="keywordtype">int</font> messageSize)<font class="keyword"></font>
00217 <font class="keyword"></font>{
00218 <font class="preprocessor">    #ifdef NTO</font>
00219 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (MsgReply(d_clientId, 0, message, messageSize) == -1)
00220         {
00221             d_status.setStatusError()
00222                 &lt;&lt; <font class="stringliteral">"[Server::replyMessage()]  "</font>
00223                 &lt;&lt; <font class="stringliteral">"Error replying to client - "</font> &lt;&lt; strerror(errno) &lt;&lt; endl;
00224         }
00225 <font class="preprocessor">    #else</font>
00226 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (Reply(d_clientId, message, messageSize) == -1)
00227         {
00228             d_status.setStatusError()
00229                 &lt;&lt; <font class="stringliteral">"[Server::replyMessage()]  "</font> &lt;&lt; strerror(errno) &lt;&lt; endl;
00230         }
00231 <font class="preprocessor">    #endif</font>
00232 <font class="preprocessor"></font>}
00233 
<a name="l00234"></a><a class="code" href="class_Server.html#a9">00234</a> <font class="keyword">inline</font> <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a8">Server::replyMessage</a>(<font class="keywordtype">int</font> iReply)<font class="keyword"></font>
00235 <font class="keyword"></font>{
00236       <a class="code" href="class_Server.html#a8">replyMessage</a>(&amp;iReply, <font class="keyword">sizeof</font>(<font class="keywordtype">int</font>));
00237 }
00238 
<a name="l00239"></a><a class="code" href="class_Server.html#a8">00239</a> <font class="keyword">inline</font> <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a8">Server::replyMessage</a>()<font class="keyword"></font>
00240 <font class="keyword"></font>{
00241       <a class="code" href="class_Server.html#a8">replyMessage</a>(0, 0);
00242 }
00243 
00244 
<a name="l00248"></a><a class="code" href="class_Server.html#a11">00248</a> <font class="keyword">inline</font> <font class="keywordtype">void</font> <a class="code" href="class_Server.html#a12">Server::receiveMessage</a>(<font class="keywordtype">void</font> *message, <font class="keywordtype">int</font> messageSize)<font class="keyword"></font>
00249 <font class="keyword"></font>{
00250 <font class="preprocessor">    #ifdef NTO</font>
00251 <font class="preprocessor"></font>        <font class="keywordtype">int</font> receiveId = MsgReceive(d_channelId, message, messageSize, 0);
00252         <font class="keywordflow">if</font> (receiveId == -1)
00253         {
00254             d_status.setStatusError()
00255                 &lt;&lt; <font class="stringliteral">"[Server::receiveMessage()]  "</font> 
00256                 &lt;&lt; <font class="stringliteral">"Error receiving message - "</font> &lt;&lt; strerror(errno) &lt;&lt; endl;
00257         }
00258 <font class="preprocessor">    #else</font>
00259 <font class="preprocessor"></font>        <font class="keywordflow">if</font> (Receive(d_clientId, message, messageSize) == -1)
00260         {
00261             d_status.setStatusError()
00262                 &lt;&lt; <font class="stringliteral">"[Server::receiveMessage()]  "</font>
00263                 &lt;&lt; <font class="stringliteral">"Error receiving message - "</font> &lt;&lt; strerror(errno) &lt;&lt; endl;
00264         }
00265 <font class="preprocessor">    #endif</font>
00266 <font class="preprocessor"></font>}
00267 
<a name="l00268"></a><a class="code" href="class_Server.html#a12">00268</a> <font class="keyword">inline</font> <font class="keywordtype">int</font> <a class="code" href="class_Server.html#a12">Server::receiveMessage</a>()<font class="keyword"></font>
00269 <font class="keyword"></font>{
00270     <font class="keywordtype">int</font> msg;
00271     
00272     <a class="code" href="class_Server.html#a12">receiveMessage</a>(&amp;msg, <font class="keyword">sizeof</font>(msg));
00273     <font class="keywordflow">return</font> msg;
00274 }
00275 
00276 
<a name="l00280"></a><a class="code" href="class_Server.html#a13">00280</a> <font class="keyword">inline</font> pid_t <a class="code" href="class_Server.html#a13">Server::receiveMessageFromAnybody</a>(<font class="keywordtype">void</font> *message, <font class="keywordtype">int</font> messageSize)<font class="keyword"></font>
00281 <font class="keyword"></font>{
00282 <font class="preprocessor">#ifdef NTO</font>
00283 <font class="preprocessor"></font>    <font class="keyword">struct </font>_msg_info msgInfo;
00284     d_clientId = MsgReceive(d_channelId, message, messageSize, &amp;msgInfo);
00285     <font class="keywordflow">if</font> (d_clientId == -1)
00286     {
00287         d_status.setStatusError()
00288             &lt;&lt; <font class="stringliteral">"[Server::receiveMessage()]  "</font>
00289             &lt;&lt; <font class="stringliteral">"Error receiving message - "</font> &lt;&lt; strerror(errno) &lt;&lt; endl;
00290     }
00291     <font class="keywordflow">return</font> msgInfo.pid;
00292 <font class="preprocessor">#else</font>
00293 <font class="preprocessor"></font>    d_clientId = Receive(0, message, messageSize);
00294     <font class="keywordflow">if</font> (d_clientId &lt; 0)
00295     {
00296         d_status.setStatusError()
00297             &lt;&lt; <font class="stringliteral">"[Server::receiveMessage()]  "</font>
00298             &lt;&lt; <font class="stringliteral">"Error receiving message - "</font> &lt;&lt; strerror(errno) &lt;&lt; endl;
00299     }
00300     
00301     <font class="keywordflow">return</font> d_clientId;
00302 <font class="preprocessor">#endif</font>
00303 <font class="preprocessor"></font>}
00304 
00305 
00306 <font class="preprocessor">#endif</font>
00307 <font class="preprocessor"></font>
00308 
00309 
00310 
00311 
00312 
00313 
</div></pre></body>
</html>
