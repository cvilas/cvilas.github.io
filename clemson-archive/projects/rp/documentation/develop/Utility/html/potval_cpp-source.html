<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>potval.cpp Source File</title>
<link href="stylesheet.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Wed Jul 2 17:02:28 2003 -->
<h1>potval.cpp</h1><div class="fragment"><pre>00001   
00002 
00003 <font class="preprocessor">#include &lt;iostream.h&gt;</font>
00004 <font class="preprocessor">#include &lt;string&gt;</font>
00005 
00006 
00007 <font class="preprocessor">#include "RoboticPlatform.hpp"</font>
00008 <font class="preprocessor">#include "ObjectManager.hpp"</font>
00009 <font class="preprocessor">#include "Puma560.hpp"</font>
00010 <font class="preprocessor">#include "Puma560Model.hpp"</font>
00011 <font class="preprocessor">#include "DefaultTrajectoryGenerator.hpp"</font>
00012 <font class="preprocessor">#include "Vector.hpp"</font>
00013 <font class="preprocessor">#include "Config.hpp"</font>
00014 
00027 <font class="keyword">class </font><a class="code" href="class_PotVal.html">PotVal</a> : <font class="keyword">public</font> Puma560
00028 {
00029   <font class="keyword">protected</font>:
00030     <font class="keyword">typedef</font> Puma560 Parent;
00031 
00032   <font class="keyword">public</font>:
00033 
00034   
00035     <a class="code" href="class_PotVal.html#a0">PotVal</a>();
00040     <a class="code" href="class_PotVal.html#a0">PotVal</a> (<font class="keyword">const</font> <font class="keywordtype">char</font> *objectName);
00046     <a class="code" href="class_PotVal.html#a2">~PotVal</a>();
00052     <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a3">startRecording</a>();
00056     <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a4">stopRecording</a>();
00060     <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a5">setRecordingFrequency</a>(<font class="keywordtype">double</font> frequency);
00068     <font class="keywordtype">int</font> <a class="code" href="class_PotVal.html#a6">linearInterpolate</a>(Vector&lt;6&gt; &amp;slope, Vector&lt;6&gt; &amp;intercept);
00073     Vector&lt;6, int&gt; <a class="code" href="class_PotVal.html#a7">getEncoderIndexPosition</a>();
00080     <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a8">filePotEncoderData</a>(<font class="keywordtype">int</font> jointNumber, <font class="keywordtype">char</font> *filename);
00092     <font class="keyword">virtual</font> <font class="keywordtype">int</font> <a class="code" href="class_PotVal.html#a9">control</a>();
00096     <font class="keyword">virtual</font> <font class="keywordtype">int</font> <a class="code" href="class_PotVal.html#a10">startControl</a>();
00103   <font class="keyword">private</font>:
00104     <font class="keywordtype">void</font> PotValInit();
00109   <font class="keyword">private</font>:
00110     <font class="keywordtype">bool</font> d_isRecording;
00115     Vector&lt;6&gt; d_potRecord[512];
00119     Vector&lt;6, int&gt; d_encoderRecord[512];
00123     <font class="keywordtype">int</font> d_movementRange;
00127         <font class="keywordtype">double</font> d_recordFrequency;
00131         <font class="keywordtype">int</font> d_counter;
00135         Vector&lt;6, int&gt; d_encoderIndexPosition;
00138 };
00139 
00140 
<a name="l00144"></a><a class="code" href="class_PotVal.html#a0">00144</a> <a class="code" href="class_PotVal.html#a0">PotVal::PotVal</a>()
00145 : Puma560()
00146 {
00147     PotValInit();
00148 }
00149 
00150 
<a name="l00151"></a><a class="code" href="class_PotVal.html#a1">00151</a> <a class="code" href="class_PotVal.html#a0">PotVal::PotVal</a> (<font class="keyword">const</font> <font class="keywordtype">char</font> *objectName)
00152     : Puma560()
00153 {
00154     PotValInit();
00155     init(objectName);
00156 }
00157 
<a name="l00161"></a><a class="code" href="class_PotVal.html#a2">00161</a> <a class="code" href="class_PotVal.html#a2">PotVal::~PotVal</a> ()<font class="keyword"></font>
00162 <font class="keyword"></font>{
00163     exit();
00164 }
00165 
00166 
00170 <font class="keywordtype">void</font> PotVal::PotValInit()<font class="keyword"></font>
00171 <font class="keyword"></font>{
00172     d_movementRange = 0;
00173     d_isRecording = <font class="keyword">false</font>;
00174     d_counter = 0;
00175     d_encoderIndexPosition = 10000;
00176 }
00177 
00178 
<a name="l00182"></a><a class="code" href="class_PotVal.html#a3">00182</a> <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a3">PotVal::startRecording</a>()<font class="keyword"></font>
00183 <font class="keyword"></font>{
00184     d_isRecording = <font class="keyword">true</font>;
00185 }
00186 
<a name="l00190"></a><a class="code" href="class_PotVal.html#a4">00190</a> <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a4">PotVal::stopRecording</a>()<font class="keyword"></font>
00191 <font class="keyword"></font>{
00192     d_isRecording = <font class="keyword">false</font>;
00193 }
00194 
<a name="l00198"></a><a class="code" href="class_PotVal.html#a5">00198</a> <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a5">PotVal::setRecordingFrequency</a>(<font class="keywordtype">double</font> frequency)<font class="keyword"></font>
00199 <font class="keyword"></font>{
00200     d_recordFrequency = frequency;
00201 }
00202 
<a name="l00206"></a><a class="code" href="class_PotVal.html#a10">00206</a> <font class="keywordtype">int</font> <a class="code" href="class_PotVal.html#a10">PotVal::startControl</a>()<font class="keyword"></font>
00207 <font class="keyword"></font>{
00208     Puma560::startControl();
00209     d_counter = 0;
00210     
00211 }
00212 
<a name="l00216"></a><a class="code" href="class_PotVal.html#a9">00216</a> <font class="keywordtype">int</font> <a class="code" href="class_PotVal.html#a9">PotVal::control</a>()<font class="keyword"></font>
00217 <font class="keyword"></font>{
00218     Puma560::control();
00219     
00220     Vector&lt;6&gt; potValue;
00221     Vector&lt;6, int&gt; encoderValue;
00222     <font class="keywordtype">int</font> encoderIndexValue;
00223     
00224     <font class="keywordflow">if</font> (d_isRecording)
00225     {
00226         <font class="keywordflow">if</font> ( d_counter &gt;= (<font class="keywordtype">int</font>)(1/(d_recordFrequency * d_controlPeriod)) )
00227         {
00228             d_counter =  -1;
00229             d_movementRange += 1;
00230 
00231             <font class="keywordflow">for</font> (<font class="keywordtype">int</font> joint = 1; joint &lt;=6; joint++)
00232             {
00233                 <font class="keywordflow">if</font> (d_ioBoardClient)
00234                 {
00235                     encoderValue(joint) =  d_ioBoardClient-&gt;
00236                                 getEncoderValue(d_encoderStartChannel + joint - 1);
00240                     <font class="keywordflow">if</font>( isIndexPulse(joint) )
00241                     {
00242                         <font class="keywordflow">if</font> ( d_useDigitalInputsForIndexPulses )
00243                              encoderIndexValue = d_ioBoardClient-&gt;getEncoderValue
00244                                                                                     (d_encoderStartChannel + joint - 1);
00245                         <font class="keywordflow">else</font>
00246                             encoderIndexValue = d_ioBoardClient-&gt;getEncoderIndexValue(joint - 1);
00247                         
00248                         <font class="keywordflow">if</font>( abs(encoderIndexValue) &lt; abs(d_encoderIndexPosition(joint)) ) 
00249                             d_encoderIndexPosition(joint) = encoderIndexValue;
00250                     }
00251                 }
00252                 d_potRecord[d_movementRange - 1] = d_potValue;<font class="comment">//potValue;</font>
00253                 d_encoderRecord[d_movementRange - 1] = encoderValue;
00254             }
00255         }
00256         d_counter++;
00257     }
00258     <font class="keywordflow">return</font> 0;
00259 }
00260 
00261 
<a name="l00265"></a><a class="code" href="class_PotVal.html#a6">00265</a> <font class="keywordtype">int</font> <a class="code" href="class_PotVal.html#a6">PotVal::linearInterpolate</a>( Vector&lt;6&gt; &amp;slope, Vector&lt;6&gt; &amp;intercept)<font class="keyword"></font>
00266 <font class="keyword"></font>{
00267   <font class="keywordtype">int</font> i;
00268   Vector&lt;6&gt; summationPotRecord;
00269   Vector&lt;6&gt; summationPotRecordSquare;
00270   Vector&lt;6, int&gt; summationEncoderRecord;
00271   Vector&lt;6&gt; summationEncoderPot;
00272   Vector&lt;6&gt; denom;
00273 
00276  summationPotRecord  = 0.0; summationEncoderRecord  = 0.0;
00277   summationPotRecordSquare = 0.0; summationEncoderPot = 0.0;
00278 
00279   <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> joint = 1; joint &lt;= 6; joint++ )
00280   {
00281     <font class="keywordflow">for</font> ( i = 0; i &lt; d_movementRange; i++)
00282     {
00283         summationPotRecord(joint) += d_potRecord[i](joint); 
00284         summationEncoderRecord(joint) += d_encoderRecord[i](joint);
00285         summationPotRecordSquare(joint) += d_potRecord[i](joint) * d_potRecord[i](joint);
00286         summationEncoderPot(joint) += d_potRecord[i](joint) * d_encoderRecord[i](joint);
00287     }
00288   
00289     denom(joint) = d_movementRange * summationPotRecordSquare(joint) 
00290                                 - summationPotRecord(joint) * summationPotRecord(joint);
00291     
00295   <font class="keywordflow">if</font> (   denom(joint) == 0.0 || 
00296             ( d_encoderRecord[0](joint) &gt; (d_encoderRecord[d_movementRange-1](joint) - 20) 
00297                 &amp;&amp; d_encoderRecord[0](joint) &lt; (d_encoderRecord[d_movementRange-1](joint) + 20) ) )
00298     {
00299         slope(joint) = 0;
00300         intercept(joint) = 0;
00301     }
00302     <font class="keywordflow">else</font>
00303     {   
00304         slope(joint) = (d_movementRange * summationEncoderPot(joint) - summationPotRecord(joint) 
00305                                    * summationEncoderRecord(joint) ) / denom(joint); 
00306         intercept(joint) = (summationPotRecordSquare(joint) * summationEncoderRecord(joint) 
00307                                             - summationPotRecord(joint) * summationEncoderPot(joint)) / denom(joint);
00308     }
00309   }
00310   <font class="keywordflow">return</font> 0;
00311 }
00312 
<a name="l00316"></a><a class="code" href="class_PotVal.html#a7">00316</a> Vector&lt;6, int&gt; <a class="code" href="class_PotVal.html#a7">PotVal::getEncoderIndexPosition</a>()<font class="keyword"></font>
00317 <font class="keyword"></font>{
00318     <font class="keywordflow">return</font> d_encoderIndexPosition;
00319 }
00320 
<a name="l00324"></a><a class="code" href="class_PotVal.html#a8">00324</a> <font class="keywordtype">void</font> <a class="code" href="class_PotVal.html#a8">PotVal::filePotEncoderData</a>(<font class="keywordtype">int</font> jointNumber, <font class="keywordtype">char</font> *fileName)<font class="keyword"></font>
00325 <font class="keyword"></font>{
00326     FILE *recordFile;
00327     recordFile = fopen(fileName, <font class="stringliteral">"w+"</font>);
00328     
00329     fprintf(recordFile, <font class="stringliteral">"%s%d\n"</font>, <font class="stringliteral">"%Record for pot-encoder values for joint "</font>, jointNumber);
00330     fprintf(recordFile, <font class="stringliteral">"%s\n"</font>, <font class="stringliteral">"%Order of recorded value is potvalue followed"</font>);
00331     fprintf(recordFile, <font class="stringliteral">"%s\n"</font>, <font class="stringliteral">"%by corresponding encoder value."</font>);
00332     fprintf(recordFile, <font class="stringliteral">"jointNumber = %d\n"</font>, jointNumber );
00333     fprintf(recordFile, <font class="stringliteral">"numRecords = %d\n\n"</font>, d_movementRange );
00334 
00335     <font class="keywordflow">for</font> ( <font class="keywordtype">int</font> index = 0; index &lt; d_movementRange; index++ )
00336     {
00337         fprintf( recordFile, <font class="stringliteral">"%s%d%s%d%s%f\n"</font>,<font class="stringliteral">"pot"</font>, jointNumber,<font class="stringliteral">"("</font>, (index+1), <font class="stringliteral">") = "</font>, 
00338                                                                                                     d_potRecord[index](jointNumber) );  
00339         fprintf( recordFile, <font class="stringliteral">"%s%d%s%d%s%d\n"</font>,<font class="stringliteral">"encoder"</font>, jointNumber,<font class="stringliteral">"("</font>, (index+1), <font class="stringliteral">") = "</font>, 
00340                                                                                             d_encoderRecord[index](jointNumber) );
00341     
00342     }
00343     fclose( recordFile );
00344 }
00345 
00350 <font class="keywordtype">int</font> main (<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[])<font class="keyword"></font>
00351 <font class="keyword"></font>{
00352     OpenArchitectureManipulator::setAutoEnableArmPowerOff();
00353     
00354     RoboticPlatform::init(argc, argv);
00355     <font class="keywordflow">if</font> (RoboticPlatform::d_status.isStatusError())
00356     {
00357         cout &lt;&lt; RoboticPlatform::d_status.getMessageText() &lt;&lt; endl;
00358         RoboticPlatform::d_status.setStatusOk();
00359         <font class="keywordflow">return</font> -1;
00360     }
00361     
00362     CmdLineArgs *commandLine = RoboticPlatform::getCommandLineArguments();  
00363     
00364     <a class="code" href="class_PotVal.html">PotVal</a> pumaPotVal; <font class="comment">// Puma potcal object.</font>
00365     pumaPotVal.setDynamicSimulationModeOff();
00366     
00367     Vector&lt;6&gt; potSlope; <font class="comment">// calculated pot slope values.</font>
00368     Vector&lt;6&gt; potIntercept; <font class="comment">// calculated pot intercept values.</font>
00369     Vector&lt;6, int&gt; encoderAtIndex; <font class="comment">// first encoder index in positive direction of joint motion.</font>
00370     Vector&lt;6&gt; startPosition; <font class="comment">// calibration procedure starts at this position.</font>
00371     Vector&lt;6&gt; endPosition; <font class="comment">// calibration procedure ends at this position</font>
00372     Vector&lt;6&gt; initialPosition; <font class="comment">// Puma rest position.</font>
00373     Vector&lt;6&gt; range;    <font class="comment">// total range of movement for the joints. </font>
00374 
00375 
00378   <font class="keywordflow">if</font>( pumaPotVal.isSimulationModeOn() )
00379         cout &lt;&lt; endl &lt;&lt; <font class="stringliteral">"**** WARNING : SIMULATION MODE - Calibration will not take place. ****"</font> &lt;&lt; endl;
00380     
00381 
00384   <font class="keywordflow">if</font>( commandLine-&gt;isOption(<font class="stringliteral">"i"</font>) )
00385     {
00386         <font class="keyword">const</font> <font class="keywordtype">char</font> *angles = commandLine-&gt;getStringOption(<font class="stringliteral">"i"</font>);
00387         sscanf( angles, <font class="stringliteral">"%lf %lf %lf %lf %lf %lf"</font>,
00388                         &amp;initialPosition(1), &amp;initialPosition(2), &amp;initialPosition(3),
00389                         &amp;initialPosition(4), &amp;initialPosition(5), &amp;initialPosition(6) ); 
00390     }
00391     <font class="keywordflow">else</font>
00392     {
00393         initialPosition = 0, 90, -90, 0, 0, 0;
00394     }
00395     
00396     <font class="keywordflow">if</font>( commandLine-&gt;isOption(<font class="stringliteral">"r"</font>) )
00397     {
00398         <font class="keyword">const</font> <font class="keywordtype">char</font> *angles = commandLine-&gt;getStringOption(<font class="stringliteral">"r"</font>);
00399         sscanf( angles, <font class="stringliteral">"%lf %lf %lf %lf %lf %lf"</font>,
00400                         &amp;range(1), &amp;range(2), &amp;range(3), &amp;range(4), &amp;range(5), &amp;range(6) ); 
00401     }
00402     <font class="keywordflow">else</font>
00403     {
00404         range = 200, 60, 60, 80, 100, 100;
00405     }
00406     
00407     
00410   DefaultTrajectoryGenerator&lt;6&gt; tragen;
00411     tragen.setSpeedScale(0.1);
00412     tragen.setBlockingMovesOff();
00413     pumaPotVal.setTrajectoryGenerator(tragen);
00414     
00428     initialPosition = initialPosition * M_PI/180;
00429     range = range * M_PI/180;
00430     
00431     startPosition = initialPosition - range * 0.5;
00432     endPosition = initialPosition + range * 0.5;
00433     
00434     pumaPotVal.calibrateJointPosition(initialPosition);
00435     pumaPotVal.<a class="code" href="class_PotVal.html#a5">setRecordingFrequency</a>(10);
00436     
00437     pumaPotVal.enableArmPower();
00438 
00439     tragen.setSpeedScale(1);
00440     tragen.move(startPosition);
00441     tragen.stop(0.5);
00442     tragen.waitForLastRequestCompleted();
00443     pumaPotVal.<a class="code" href="class_PotVal.html#a3">startRecording</a>();
00444     
00445     tragen.setSpeedScale(0.2);
00446     tragen.move(endPosition);
00447     tragen.stop(0.5);
00448     tragen.waitForLastRequestCompleted();
00449     pumaPotVal.<a class="code" href="class_PotVal.html#a4">stopRecording</a>();
00450         
00451     tragen.setSpeedScale(1);
00452     tragen.move(initialPosition);
00453     tragen.stop(0.5);
00454     tragen.waitForLastRequestCompleted();
00455 
00456     pumaPotVal.disableArmPower();
00457     
00458         
00461   pumaPotVal.<a class="code" href="class_PotVal.html#a6">linearInterpolate</a>(potSlope, potIntercept);
00462     encoderAtIndex = pumaPotVal.<a class="code" href="class_PotVal.html#a7">getEncoderIndexPosition</a>();
00465   cout &lt;&lt; <font class="stringliteral">"Pot slope values are : "</font> &lt;&lt; transpose(potSlope) &lt;&lt; endl;
00466     cout &lt;&lt; <font class="stringliteral">"Pot intercept values are : "</font> &lt;&lt; transpose(potIntercept) &lt;&lt; endl;
00467     cout &lt;&lt; <font class="stringliteral">"Encoder index position : "</font> &lt;&lt; transpose(encoderAtIndex) &lt;&lt; endl;
00468 
00469 
00470 
00474     <font class="keywordtype">char</font> choice;
00475     cout &lt;&lt; endl &lt;&lt; <font class="stringliteral">"Do you want the values to be written into a configuration file? "</font>
00476              &lt;&lt; <font class="stringliteral">"[y/n]"</font> &lt;&lt; endl;
00477     cin &gt;&gt; choice;
00478     
00479     <font class="keywordflow">if</font> ( choice == <font class="charliteral">'y'</font> )
00480     {
00481         string fileName;
00482         cout &lt;&lt; endl &lt;&lt; <font class="stringliteral">"Please specify the configuration filename with the path."</font>
00483                  &lt;&lt;<font class="stringliteral">" (example : /usr/qrts/rp/config/Puma560.cfg) "</font> &lt;&lt; endl;
00484         cin &gt;&gt; fileName;
00485     
00486         Config configFile;
00487         configFile.setFileName( fileName.c_str() );
00488         configFile.loadConfiguration();
00489         <font class="keywordflow">if</font> ( configFile.d_status.isStatusError() )
00490         {
00491             cerr &lt;&lt; <font class="stringliteral">"Can't find configuration file "</font> 
00492                      &lt;&lt; configFile.getResolvedConfigFullPath() &lt;&lt; endl
00493                      &lt;&lt; <font class="stringliteral">"Creating configuration file...."</font> &lt;&lt; endl;
00494         }
00495         
00496         configFile.setArrayEntry( <font class="stringliteral">"ControlParameters"</font>, <font class="stringliteral">"Puma560::d_potIntercept"</font>, 
00497                                                                 potIntercept.getElementsPointer(), 6, 1 );
00498         configFile.setArrayEntry( <font class="stringliteral">"ControlParameters"</font>, <font class="stringliteral">"Puma560::d_potSlope"</font>, 
00499                                                                 potSlope.getElementsPointer(), 6, 1);
00500         configFile.setArrayEntry( <font class="stringliteral">"ControlParameters"</font>, <font class="stringliteral">"Puma560::d_encoderAtIndex"</font>, 
00501                                                                 encoderAtIndex.getElementsPointer(), 6, 1 );
00502         
00503         configFile.saveConfiguration();
00504         
00505         cout &lt;&lt; endl &lt;&lt; <font class="stringliteral">"The parameters have been saved to the configuration file "</font>
00506                  &lt;&lt; configFile.getResolvedConfigFullPath() &lt;&lt; endl;
00507     }
00508     
00509     <font class="comment">/*</font>
00512 <font class="comment">  pumaPotVal.filePotEncoderData(1, "joint1data.m");</font>
00513 <font class="comment">    pumaPotVal.filePotEncoderData(2, "joint2data.m");</font>
00514 <font class="comment">    pumaPotVal.filePotEncoderData(3, "joint3data.m");</font>
00515 <font class="comment">    pumaPotVal.filePotEncoderData(4, "joint4data.m");</font>
00516 <font class="comment">    pumaPotVal.filePotEncoderData(5, "joint5data.m");</font>
00517 <font class="comment">    pumaPotVal.filePotEncoderData(6, "joint6data.m");</font>
00518 <font class="comment">    */</font>
00519     
00520     RoboticPlatform::exit();
00521     <font class="keywordflow">return</font> 0;
00522 }
00523 
</div></pre></body>
</html>
