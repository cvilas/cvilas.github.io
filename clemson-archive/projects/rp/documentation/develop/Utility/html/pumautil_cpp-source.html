<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta name="robots" content="noindex">
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>pumautil.cpp Source File</title>
<link href="stylesheet.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.3 on Wed Jul 2 17:02:29 2003 -->
<h1>pumautil.cpp</h1><div class="fragment"><pre>00001 
00002 <font class="preprocessor">#include "ControlProgram.hpp"</font>
00003 <font class="preprocessor">#include "IOBoardClient.hpp"</font>
00004 <font class="preprocessor">#include "CmdLineArgs.hpp"</font>
00005 
00006 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00007 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00008 <font class="preprocessor">#include &lt;math.h&gt;</font>
00009 <font class="preprocessor">#include &lt;signal.h&gt;</font>
00010 
00011 <font class="preprocessor">#include "ButterworthFilter.hpp"</font>
00012 
00013 <font class="preprocessor">#define PI          3.14159265358979320</font>
00014 <font class="preprocessor"></font><font class="preprocessor">#define DEGTORAD    0.01745329251994330</font>
00015 <font class="preprocessor"></font><font class="preprocessor">#define RADTODEG    57.2957795130823210</font>
00016 <font class="preprocessor"></font>
00017 <font class="preprocessor">#define GRAVITY_MODE  0</font>
00018 <font class="preprocessor"></font><font class="preprocessor">#define MOVE_TO_END   1</font>
00019 <font class="preprocessor"></font><font class="preprocessor">#define POTVAL        2</font>
00020 <font class="preprocessor"></font>
00021     
00022 
00023 <font class="keyword">class </font>PumaUtil : <font class="keyword">public</font> ControlProgram
00024 {
00025   <font class="keyword">public</font>:
00026     PumaUtil (<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[]) : ControlProgram (argc, argv) {}
00027     ~PumaUtil ()<font class="keyword"> </font>{};
00028 
00029   <font class="keyword">protected</font>:
00030     <font class="keywordtype">void</font> pdControl();
00031     <font class="keywordtype">void</font> gravityLoad(<font class="keywordtype">double</font> *jointAngles, <font class="keywordtype">double</font> *gload);
00032         
00033     <font class="keywordtype">void</font> angleToEncoder(<font class="keywordtype">double</font> *jointAngles, <font class="keywordtype">int</font> *encoderValue);
00034     <font class="keywordtype">void</font> encoderToRadians (<font class="keywordtype">int</font> *encoderValue, <font class="keywordtype">double</font> *jointAngles);
00035         
00036     <font class="keywordtype">void</font> initParametersFromCommandLine ();
00037     
00038     <font class="keywordtype">int</font> checkJointLimit(<font class="keywordtype">int</font> joint, <font class="keywordtype">double</font> jointAngle);
00039     <font class="keywordtype">int</font> jointLevelTrajectoryGenerator (<font class="keywordtype">double</font> movementscale);
00040                 
00041     <font class="keywordtype">void</font> setEncoderValues(<font class="keywordtype">int</font> *encoderValue);
00042     <font class="keywordtype">void</font> setTorqueValues(<font class="keywordtype">double</font> *values); 
00043         
00044     <font class="keywordtype">void</font> enableArmPower();
00045     <font class="keywordtype">void</font> disableArmPower();
00046 
00047       <font class="keywordtype">int</font> linearInterpolate (<font class="keywordtype">double</font> *slope, <font class="keywordtype">double</font> *interscept,
00048                                                     <font class="keywordtype">double</font> *Xvector, <font class="keywordtype">double</font> *Yvector,
00049                                                     <font class="keywordtype">int</font> size);
00050     <font class="keywordtype">double</font>  maximum(<font class="keywordtype">double</font> *vector, <font class="keywordtype">int</font> size);
00051             
00052       <font class="keywordtype">int</font> enterControl ();
00053     <font class="keywordtype">int</font> exitControl ();
00054     <font class="keywordtype">int</font> startControl ();
00055     <font class="keywordtype">int</font> stopControl ();
00056     <font class="keywordtype">int</font> control ();
00057     <font class="keywordtype">int</font> readConfiguration ();
00058 
00059   <font class="keyword">protected</font>:
00060 
00061       <font class="keywordtype">double</font> jointAngles[6];
00062     <font class="keywordtype">double</font> jointLimit[6];
00063         
00064     <font class="keywordtype">int</font>    EncoderValue[6];    <font class="comment">// integer values to get the encoder counts</font>
00065     <font class="keywordtype">double</font> encoderValues[6];
00066         
00067     <font class="keywordtype">double</font> potValues[6];
00068         
00069     <font class="keywordtype">int</font>    indexBitValue[6];
00070     <font class="keywordtype">double</font> indexCounter[6];
00071     <font class="keywordtype">int</font>    indexPhase[6];
00072     <font class="keywordtype">int</font>    prevEncoderIndexValue[6];
00073         
00074     <font class="keywordtype">double</font> encoderAtIndex[6];
00075     <font class="keywordtype">double</font> potAtIndex[6];
00076 
00077     <font class="keywordtype">double</font> encoderRecord[256];  <font class="comment">// required to calculate pot vs encoder</font>
00078     <font class="keywordtype">double</font> potRecord[256];      <font class="comment">// relation for potval</font>
00079     
00080     <font class="keywordtype">double</font> endOfMotionFlag;
00081     <font class="keywordtype">int</font> robotStopped;
00082         
00083     <font class="keywordtype">double</font> torque[6];
00084         
00085       <font class="keywordtype">double</font> initialAngles[6];
00086     <font class="keywordtype">double</font> finalPosition[6];
00087     <font class="keywordtype">double</font> Kp[6];     <font class="comment">// Proportional gain</font>
00088     <font class="keywordtype">double</font> Kd[6];     <font class="comment">// Derivative gain</font>
00089              
00090   
00091     <font class="keywordtype">int</font> d_armPowerDigitalOutChannel;
00092             
00093     <font class="keywordtype">int</font> d_armPowerDigitalOutValue;
00094                 
00095     <font class="keywordtype">int</font> d_armPowerDigitalInChannel;
00096             
00097     <font class="keywordtype">int</font> d_armPowerDigitalInValue;
00098     
00099     <font class="keywordtype">int</font> d_useDigitalInputsForIndexPulses;
00100                 
00101     <font class="keywordtype">double</font> encoderCountPerDeg[6];
00102     <font class="keywordtype">double</font> encoderCountPerRad[6];
00103     <font class="keywordtype">double</font> angleMin[6];
00104     <font class="keywordtype">double</font> angleMax[6];
00105     <font class="keywordtype">double</font> voltageScale[6];
00106     <font class="keywordtype">double</font> cfactor45, cfactor46, cfactor56;
00107         
00108       
00109     <font class="keywordtype">double</font> d_armPowerEnabledTime;
00110     <font class="keywordtype">double</font> controlTimer;
00111     <font class="keywordtype">double</font> time;             <font class="comment">// same the d_elapsedTime of the super class</font>
00112     <font class="keywordtype">double</font> oldJointAngles[2][6];
00113     <font class="keywordtype">double</font> velocity[6];
00114     <font class="keywordtype">double</font> motionScale;
00115     <font class="keywordtype">double</font> controlType; <font class="comment">// user defines the type of the controller</font>
00116                         
00117     <font class="keywordtype">int</font> potvalJoint; <font class="comment">// the joint that the potval will be applied</font>
00118     <font class="keywordtype">int</font> recordMode;
00119         
00120       <font class="keywordtype">double</font> qd[6];
00121     <font class="keywordtype">double</font> qddot[6];
00122     <font class="keywordtype">double</font> qddoubledot[6];
00123     <font class="keywordtype">double</font> delta[6];
00124                             
00125       <font class="keyword">const</font> <font class="keywordtype">char</font> *d_ioBoardServerName;
00126     IOBoardClient *d_ioBoardClient;     <font class="comment">// IO Board Client</font>
00127     ButterworthFilter&lt;double&gt; *velocityfilter;  <font class="comment">//velocity filters</font>
00128 };
00129 
00130 
00131 
00132 <font class="keywordtype">int</font> PumaUtil::enterControl()<font class="keyword"></font>
00133 <font class="keyword"></font>{
00134     velocityfilter = <font class="keyword">new</font> ButterworthFilter&lt;double&gt; [6];
00135     
00136       
00137     registerLogVariable (jointAngles, <font class="stringliteral">"jointAngles"</font>, 
00138                                              <font class="stringliteral">"Current joint angles of the manipulator"</font>, 6);
00139 
00140     registerLogVariable (encoderValues, <font class="stringliteral">"encoderValues"</font>, 
00141                                              <font class="stringliteral">"Current encoder values"</font>, 6);
00142      
00143     registerLogVariable (potValues, <font class="stringliteral">"potValues"</font>, 
00144                                              <font class="stringliteral">"Current potentiometer values"</font>, 6);
00145      
00146     registerLogVariable (indexCounter, <font class="stringliteral">"indexCounter"</font>, 
00147                                              <font class="stringliteral">"Index pulse counter"</font>, 6);
00148      
00149     registerLogVariable (encoderAtIndex, <font class="stringliteral">"encoderAtIndex"</font>, 
00150                                              <font class="stringliteral">"Encoder values when index pulse occurs"</font>, 6);
00151      
00152     registerLogVariable (qd, <font class="stringliteral">"qd"</font>, <font class="stringliteral">"Desired trajectory"</font>, 6);
00153      
00154     registerLogVariable (&amp;endOfMotionFlag, <font class="stringliteral">"endOfMotionFlag"</font>,<font class="stringliteral">"1 if end of motion "</font>);
00155      
00156             
00157       
00158     registerControlParameter (initialAngles, <font class="stringliteral">"initialAngles"</font>,
00159                                                             <font class="stringliteral">"The position that the robot is in at\n"</font>
00160                                                             <font class="stringliteral">"control start (inital angles in degrees)"</font>,  6);
00161      
00162     registerControlParameter (finalPosition, <font class="stringliteral">"finalPosition"</font>,
00163                                                             <font class="stringliteral">"Final position of the manipulator\n"</font>
00164                                                             <font class="stringliteral">"in joint angles (degrees)"</font>,  6);
00165 
00166     registerControlParameter (&amp;controlType, <font class="stringliteral">"controlType"</font>,
00167                                                         <font class="stringliteral">"0: Gravity Compensation\n"</font>
00168                                                         <font class="stringliteral">"1: Move to Position Motion\n"</font>
00169                                                         <font class="stringliteral">"2: Do the Potval Calibration"</font>);
00170      
00171     registerControlParameter (&amp;potvalJoint, <font class="stringliteral">"potValJoint"</font>, 
00172                                                         <font class="stringliteral">"The joint to apply potval (1-6)"</font> );
00173             
00174     registerControlParameter (&amp;motionScale, <font class="stringliteral">"motionScale"</font>,
00175                                                         <font class="stringliteral">"Adjusts the speed of trajectory\n"</font>
00176                                                         <font class="stringliteral">"(the smaller the value, the faster the motion"</font>);
00177 
00178     registerControlParameter ((<font class="keywordtype">double</font> *) Kp, <font class="stringliteral">"Kp"</font>, <font class="stringliteral">"Proportional Gains"</font>, 6);
00179     registerControlParameter ((<font class="keywordtype">double</font> *) Kd, <font class="stringliteral">"Kd"</font>, <font class="stringliteral">"Derivative Gains"</font>, 6);
00180     registerControlParameter ((<font class="keywordtype">double</font> *) voltageScale,
00181         <font class="stringliteral">"voltageScale"</font>, <font class="stringliteral">"Torque to voltage scale"</font>, 6);
00182     
00183     d_controlFrequency = 1000; <font class="comment">// Control freq. in Hz</font>
00184     d_controlDuration = 10;    <font class="comment">// Control duration in seconds </font>
00185     d_runForever = 1;
00186     
00187       voltageScale[0] =  0.051229; 
00188     voltageScale[1] = -0.026824;
00189     voltageScale[2] =  0.055928; 
00190     voltageScale[3] = -0.206611; 
00191     voltageScale[4] = -0.248756; 
00192     voltageScale[5] = -0.234741;
00193     
00194     initialAngles[0] = 0.0;
00195     initialAngles[1] = -90.0;
00196     initialAngles[2] = 90.0;
00197     initialAngles[3] = 0.0;
00198     initialAngles[4] = 0.0;
00199     initialAngles[5] = 0.0;
00200 
00201     finalPosition[0] = 0.0;
00202     finalPosition[1] = -90.0;
00203     finalPosition[2] = 90.0;
00204     finalPosition[3] = 0.0;
00205     finalPosition[4] = 0.0;
00206     finalPosition[5] = 0.0;
00207     
00208     Kp[0] = 10000;    Kd[0] = 85;
00209     Kp[1] = 11000;    Kd[1] = 85;
00210     Kp[2] = 10000;    Kd[2] = 80;
00211     Kp[3] = 310;      Kd[3] = 25;
00212     Kp[4] = 300;      Kd[4] = 20;
00213     Kp[5] = 300;      Kd[5] = 20; 
00214 
00215     motionScale = 10.0;
00216 
00217       d_messageStream
00218         &lt;&lt; endl &lt;&lt; <font class="stringliteral">"----- "</font> &lt;&lt; d_applicationName &lt;&lt; <font class="stringliteral">" -----"</font> &lt;&lt; endl
00219         &lt;&lt; <font class="stringliteral">"QMotor RTK Puma Utility"</font> &lt;&lt; endl &lt;&lt; endl;
00220         
00221     <font class="keywordflow">if</font> (!d_standAloneMode)
00222     {
00223         d_messageStream
00224             &lt;&lt; <font class="stringliteral">"Set controlType to "</font> &lt;&lt; endl
00225             &lt;&lt; <font class="stringliteral">" 0: Gravity Compensation"</font> &lt;&lt; endl
00226             &lt;&lt; <font class="stringliteral">" 1: Move to Position Motion"</font> &lt;&lt; endl
00227             &lt;&lt; <font class="stringliteral">" 2: Do the Potval Calibration"</font> &lt;&lt; endl;
00228     }
00229     
00230     <font class="keywordflow">return</font> 0;
00231 }
00232 
00233 
00234 
00235 <font class="keywordtype">int</font> PumaUtil::exitControl()<font class="keyword"></font>
00236 <font class="keyword"></font>{
00237     <font class="keyword">delete</font> [] velocityfilter;
00238             
00239     <font class="keywordflow">return</font> 0;
00240 }
00241 
00242 
00243 
00244 <font class="keywordtype">void</font> PumaUtil::initParametersFromCommandLine()<font class="keyword"></font>
00245 <font class="keyword"></font>{
00246     <font class="keywordflow">if</font> (!d_cmdLine.isOption(<font class="stringliteral">"c"</font>))
00247     {
00248         d_status.setStatusError()
00249             &lt;&lt; <font class="stringliteral">"Please specify the control mode (-c option)"</font> &lt;&lt; endl;
00250         <font class="keywordflow">return</font>;
00251     }
00252          
00253       <font class="keywordflow">if</font> (d_cmdLine.isOption(<font class="stringliteral">"i"</font>))
00254     {
00255         <font class="keyword">const</font> <font class="keywordtype">char</font> *angles = d_cmdLine.getStringOption(<font class="stringliteral">"i"</font>);
00256 
00257         sscanf(angles, <font class="stringliteral">"%lf %lf %lf %lf %lf %lf"</font>,
00258             &amp;(initialAngles[0]), &amp;(initialAngles[1]), &amp;(initialAngles[2]),
00259             &amp;(initialAngles[3]), &amp;(initialAngles[4]), &amp;(initialAngles[5]));
00260     }
00261     <font class="keywordflow">else</font> 
00262     {
00263         d_status.setStatusError()
00264             &lt;&lt; <font class="stringliteral">"Please specify the initial position of the robot (-i option)"</font> &lt;&lt; endl;
00265         <font class="keywordflow">return</font>;
00266     }
00267   
00268     controlType = d_cmdLine.getDoubleOption(<font class="stringliteral">"c"</font>);
00269 
00270     <font class="keywordflow">if</font> (controlType == 1) <font class="comment">// control type is move to end..</font>
00271     {
00272         <font class="keywordflow">if</font>(d_cmdLine.isOption(<font class="stringliteral">"f"</font>))
00273         {
00274             <font class="keyword">const</font> <font class="keywordtype">char</font> *angles = d_cmdLine.getStringOption(<font class="stringliteral">"f"</font>);
00275             sscanf(angles, <font class="stringliteral">"%lf %lf %lf %lf %lf %lf"</font>,
00276                 &amp;(finalPosition[0]), &amp;(finalPosition[1]), &amp;(finalPosition[2]),
00277                 &amp;(finalPosition[3]), &amp;(finalPosition[4]), &amp;(finalPosition[5]));
00278         }
00279         <font class="keywordflow">else</font>
00280         {
00281             d_status.setStatusError()
00282                 &lt;&lt; <font class="stringliteral">"Please specify the final position of the robot (-f option)"</font> &lt;&lt; endl;
00283             <font class="keywordflow">return</font>;
00284         }
00285     }
00286     <font class="keywordflow">else</font> <font class="keywordflow">if</font> (controlType == 2) <font class="comment">// Potval type is selected</font>
00287     {
00288         <font class="keywordflow">if</font> (d_cmdLine.isOption(<font class="stringliteral">"j"</font>))
00289             potvalJoint = d_cmdLine.getIntegerOption(<font class="stringliteral">"j"</font>);
00290         <font class="keywordflow">else</font>
00291         {
00292             d_status.setStatusError()
00293                 &lt;&lt; <font class="stringliteral">"Please specify the potval joint number (option -j)"</font> &lt;&lt; endl;
00294             <font class="keywordflow">return</font>;
00295         }
00296     }
00297 }
00298 
00299 
00300 
00301 <font class="keywordtype">int</font> PumaUtil::startControl()<font class="keyword"></font>
00302 <font class="keyword"></font>{
00303     <font class="keywordflow">if</font> (d_standAloneMode)
00304     {
00305         initParametersFromCommandLine();
00306         <font class="keywordflow">if</font> (d_status.isStatusError())
00307             <font class="keywordflow">return</font> -1;
00308     }
00309         
00310       d_ioBoardClient = <font class="keyword">new</font> IOBoardClient (d_ioBoardServerName);
00311 
00312     <font class="keywordflow">if</font> (d_ioBoardClient-&gt;isStatusError ())  <font class="comment">// If couldn't locate the IOBoard server, </font>
00313     {                                       <font class="comment">// set the status and return.</font>
00314         d_status.setStatusError ()
00315             &lt;&lt; <font class="stringliteral">"[PumaUtil::startControl]  "</font>
00316             &lt;&lt; <font class="stringliteral">"Error connecting to I/O board server "</font>
00317             &lt;&lt; d_ioBoardServerName &lt;&lt; <font class="stringliteral">"."</font>;
00318         <font class="keywordflow">return</font> -1;
00319     }
00320 
00321       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> ii = 0; ii&lt;6; ii++)
00322     {
00323         velocityfilter[ii].setCutOffFrequency (500.0);
00324         velocityfilter[ii].setDampingRatio(1.0);
00325         velocityfilter[ii].setSamplingTime(1/d_controlFrequency);
00326         velocityfilter[ii].setAutoInit();
00327     }
00328     
00329     encoderCountPerDeg[0] =  173.92 ;
00330     encoderCountPerDeg[1] = -239.59 ;
00331     encoderCountPerDeg[2] =  149.18; 
00332     encoderCountPerDeg[3] = -211.21;
00333     encoderCountPerDeg[4] = -199.79;
00334     encoderCountPerDeg[5] = -213.02;
00335 
00336     encoderCountPerRad[0] =  9965;
00337     encoderCountPerRad[1]=  -13727;
00338     encoderCountPerRad[2] =  8548; 
00339     encoderCountPerRad[3] = -12102;
00340     encoderCountPerRad[4] = -11447;
00341     encoderCountPerRad[5] = -12204;
00342     
00343     cfactor45  =  0.0139037;
00344     cfactor46  = -0.0130401;
00345     cfactor56  =  0.1805560;
00346 
00347     angleMin[0] = -160.0;
00348     angleMin[1] = -215.0;
00349     angleMin[2] = -52.0;
00350     angleMin[3] = -115.0;
00351     angleMin[4] = -100.0;
00352     angleMin[5] = -215.0; 
00353             
00354     angleMax[0] = 160.0;
00355     angleMax[1] = 35.0;
00356     angleMax[2] = 232.0;
00357     angleMax[3] = 150.0;
00358     angleMax[4] = 100.0;
00359     angleMax[5] = 215.0;
00360 
00361     indexPhase[0] = 0;
00362     indexPhase[1] = 0;
00363     indexPhase[2] = 0;
00364     indexPhase[3] = 0;
00365     indexPhase[4] = 0;
00366     indexPhase[5] = 0;
00367 
00368     indexCounter[0] = 0;
00369     indexCounter[1] = 0;
00370     indexCounter[2] = 0;
00371     indexCounter[3] = 0;
00372     indexCounter[4] = 0;
00373     indexCounter[5] = 0;
00374 
00375       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> pp=0; pp&lt;6 ; pp++)
00376     {
00377             delta[pp] = DEGTORAD * ( finalPosition[pp] - initialAngles[pp] );
00378         qd[pp] = DEGTORAD*initialAngles[pp];
00379         qddot[pp] = qddoubledot[pp] = 0.0;
00380         oldJointAngles[0][pp] = oldJointAngles[1][pp] = DEGTORAD*initialAngles[pp];
00381         
00382         prevEncoderIndexValue[pp] = 0;
00383         d_ioBoardClient-&gt;setEncoderIndexValue(pp, 0);
00384     }
00385 
00386       potvalJoint = potvalJoint-1;
00387     
00388         angleToEncoder (initialAngles, EncoderValue);
00389     setEncoderValues(EncoderValue);
00390 
00391     recordMode = 0; <font class="comment">// record mode is initialized to "Off"</font>
00392     time = 0.0;
00393     controlTimer = 0.0;
00394     endOfMotionFlag = 0.0;
00395     robotStopped = 0;
00396     
00397       enableArmPower();
00398     d_armPowerEnabledTime = -1;
00399     
00400     <font class="keywordflow">return</font> 0;
00401 }
00402 
00403 
00404 
00405 <font class="keywordtype">int</font> PumaUtil::control ()<font class="keyword"></font>
00406 <font class="keyword"></font>{
00407   <font class="keywordtype">int</font> ii;
00408 
00409     <font class="keywordflow">if</font> (d_ioBoardClient-&gt;getDiginBitValue(d_armPowerDigitalInChannel)
00410         != d_armPowerDigitalInValue)
00411         <font class="keywordflow">return</font> 0;
00412 
00413     <font class="keywordflow">if</font> (d_armPowerEnabledTime == -1)
00414         d_armPowerEnabledTime = d_elapsedTime;
00415 
00416     time = d_elapsedTime - d_armPowerEnabledTime;
00417             
00418   
00419              
00420     <font class="keywordflow">for</font> ( ii=0 ; ii&lt;6 ; ii++)
00421     {
00422         EncoderValue[ii] = d_ioBoardClient-&gt;getEncoderValue(ii);
00423         encoderValues[ii] = (<font class="keywordtype">double</font>) (EncoderValue[ii]);
00424          
00425         potValues[ii] = d_ioBoardClient-&gt;getAdcValue(ii);
00426          
00427         indexBitValue[ii] = d_ioBoardClient-&gt;getDiginBitValue (ii);
00428 
00429                     <font class="keywordflow">if</font> (d_useDigitalInputsForIndexPulses)
00430         {
00431             <font class="keywordflow">if</font> ( (indexBitValue[ii] == 0)  &amp; (indexPhase[ii] == 0) )
00432             {
00433                 encoderAtIndex[ii] = EncoderValue[ii];
00434                 potAtIndex[ii] = potValues[ii];
00435                 indexCounter[ii]++;
00436                 indexPhase[ii] = 1;
00437             }
00438         }
00439         <font class="keywordflow">else</font>
00440         {
00441             <font class="keywordtype">int</font> encoderIndexValue = d_ioBoardClient-&gt;getEncoderIndexValue(ii);
00442             <font class="keywordflow">if</font> (encoderIndexValue != prevEncoderIndexValue[ii])
00443             {
00444                 prevEncoderIndexValue[ii] = encoderIndexValue;
00445                 encoderAtIndex[ii] = encoderIndexValue;
00446                 potAtIndex[ii] = potValues[ii];
00447                 indexCounter[ii]++;       
00448             }
00449         }
00450         
00451         <font class="keywordflow">if</font> ( fabs (encoderAtIndex[ii] - EncoderValue[ii]) &gt; 20 )
00452             indexPhase[ii] = 0;
00453     }
00454 
00455       
00456     <font class="keywordflow">if</font> (recordMode)
00457     {
00458         potRecord[(<font class="keywordtype">int</font>)indexCounter[potvalJoint]-1] = potAtIndex[potvalJoint];
00459         encoderRecord[(<font class="keywordtype">int</font>)indexCounter[potvalJoint]-1] = encoderAtIndex[potvalJoint];
00460     }
00461     
00462        
00463     encoderToRadians (EncoderValue, jointAngles);
00464     
00465     
00466       
00467             <font class="keywordflow">if</font> (controlType != POTVAL)
00468     {
00469      <font class="keywordflow">for</font> (<font class="keywordtype">int</font> jj = 0; jj &lt; 6 ; jj++)
00470      {
00471         <font class="keywordflow">if</font> (!checkJointLimit(jj, jointAngles[jj]) ) 
00472         {
00473             d_status.setStatusError()
00474                 &lt;&lt; <font class="stringliteral">" Joint "</font> &lt;&lt; jj &lt;&lt; <font class="stringliteral">" is very close to its joint limit "</font>
00475                 &lt;&lt; endl;
00476             <font class="keywordflow">return</font> -1;
00477         }
00478      }
00479     }
00480 
00481      
00482         endOfMotionFlag = jointLevelTrajectoryGenerator(motionScale);
00483     gravityLoad(jointAngles, torque);
00484 
00485     
00486   
00487     <font class="keywordflow">if</font> (controlType == POTVAL)
00488     {
00489         <font class="keywordflow">if</font> (!recordMode)
00490         {
00491             <font class="keywordflow">for</font> (<font class="keywordtype">int</font> kk =0;kk&lt;6; kk++)
00492                 delta[kk] = 0.0;
00493              
00494             delta[potvalJoint]
00495                 = DEGTORAD * (angleMin[potvalJoint] - initialAngles[potvalJoint]);
00496             
00497             <font class="keywordflow">if</font> (endOfMotionFlag == 1.0)
00498             {
00499                 recordMode = 1;
00500                 endOfMotionFlag = 0.0;
00501                 controlTimer = time;     <font class="comment">// setcontroller timer for the next run</font>
00502                 indexCounter[potvalJoint] = 0; <font class="comment">// reset index counter</font>
00503             }
00504         }
00505         <font class="keywordflow">else</font>
00506         {
00507                   initialAngles[potvalJoint] = angleMin[potvalJoint];
00508             delta[potvalJoint] = DEGTORAD * 
00509                                                         (angleMax[potvalJoint] - angleMin[potvalJoint]);
00510         }
00511     } <font class="comment">// end of POTVAL </font>
00512     
00513     <font class="keywordflow">if</font> (controlType != GRAVITY_MODE)
00514     {
00515         pdControl();
00516     }
00517     
00518     setTorqueValues (torque);
00519 
00520       <font class="keywordflow">if</font> (endOfMotionFlag == 1.0)
00521         robotStopped++; 
00522     <font class="keywordflow">else</font>
00523         <font class="keywordflow">if</font> (endOfMotionFlag == 0.0)
00524             robotStopped = 0;
00525 
00526     <font class="keywordflow">if</font> ((robotStopped &gt; 100) &amp;&amp; (controlType != GRAVITY_MODE))
00527         <font class="keywordflow">return</font> 1;  
00528 
00529     <font class="keywordflow">return</font> 0;
00530 }
00531 
00532 
00533 
00534 <font class="keywordtype">int</font> PumaUtil::stopControl()<font class="keyword"></font>
00535 <font class="keyword"></font>{
00536     <font class="keyword">delete</font> d_ioBoardClient;
00537 
00538     <font class="keywordtype">double</font> intercept, 
00539                  slope;
00540     <font class="keywordtype">int</font> kk;
00541     
00542     disableArmPower();
00543     
00544       <font class="keywordflow">for</font> (kk = 0; kk&lt;6; kk++)
00545         d_ioBoardClient-&gt;setDacValue(kk, 0.0);
00546 
00547         
00548     <font class="keywordflow">if</font> (controlType == POTVAL)
00549     {
00550         <font class="keywordflow">if</font> (endOfMotionFlag)
00551         {
00552             <font class="keywordflow">if</font> (indexCounter[potvalJoint] &lt; 20)
00553             {
00554                 d_status.setStatusError()
00555                     &lt;&lt; <font class="stringliteral">"Error - Only reached "</font> &lt;&lt; indexCounter[potvalJoint]
00556                     &lt;&lt; <font class="stringliteral">" index pulses."</font> &lt;&lt; endl;
00557                 <font class="keywordflow">return</font> -1;
00558             }
00559             
00560             linearInterpolate(&amp;slope, &amp;intercept,potRecord, encoderRecord,
00561                                             (<font class="keywordtype">int</font>)indexCounter[potvalJoint] );
00562                                             
00563             d_messageStream        <font class="comment">// Actually not an error ;)</font>
00564                 &lt;&lt; <font class="stringliteral">"PotVal of Joint "</font> &lt;&lt; potvalJoint + 1 &lt;&lt; <font class="stringliteral">" Completed"</font> &lt;&lt; endl
00565                 &lt;&lt; <font class="stringliteral">"Use these values as control parameters for pumacontrol:"</font> &lt;&lt; endl
00566                 &lt;&lt; <font class="stringliteral">"d_potSlope = "</font> &lt;&lt; slope &lt;&lt; endl
00567                 &lt;&lt; <font class="stringliteral">"d_potIntercept = "</font> &lt;&lt; intercept &lt;&lt; endl
00568                 &lt;&lt; endl;
00569         }
00570         <font class="keywordflow">else</font>
00571         {
00572             d_status.setStatusError()
00573                 &lt;&lt; <font class="stringliteral">"The PotVal procedure was not completed successfully"</font> &lt;&lt; endl;
00574         }
00575     }
00576 
00577     <font class="keywordflow">return</font> 0;
00578 }
00579 
00580 
00581 
00582 <font class="keywordtype">void</font> PumaUtil::gravityLoad(<font class="keywordtype">double</font> *angles, <font class="keywordtype">double</font> *gload)<font class="keyword"></font>
00583 <font class="keyword"></font>{
00584 
00585         gload[0] = 0.0 ;
00586         
00587         gload[1] = -37.196 * cos(angles[1])
00588                              - 8.445 * sin(angles[1] + angles[2])
00589                              + 1.023 * sin(angles[1]);
00590 
00591         
00592         gload[2] = - 8.445   * sin(angles[1] + angles[2])
00593                                 + 1.023 * cos(angles[1] + angles[2])
00594                                 + 0.248 * (cos(angles[1]+ angles[2])*cos(angles[3])*sin(angles[4])
00595                                 + cos(angles[4])*sin(angles[1]+angles[2]) ) ;
00596                 
00597         gload[3] = 0.028   * sin(angles[1] - angles[2]) * sin(angles[3]) * sin(angles[4]) ;
00598 
00599         gload[4] = -0.028  * ( (cos(angles[1] - angles[2]) * sin (angles[4]))
00600                              + (sin(angles[1] - angles[2]) * cos(angles[3])* cos(angles[4]) ) );
00601 
00602         gload[5] = 0.0;
00603 
00604 }
00605 
00606 
00607 
00608 <font class="keywordtype">void</font> PumaUtil::pdControl()<font class="keyword"></font>
00609 <font class="keyword"></font>{
00610     <font class="keywordtype">double</font> factor = d_controlFrequency/2.0;
00611     <font class="keywordtype">int</font> i;
00612 
00613       <font class="keywordflow">for</font> (i= 1; i&lt;6; i++)
00614     {
00615         velocity[i] = factor * (jointAngles[i] - oldJointAngles[1][i]);
00616         
00617         velocity[i] = velocityfilter[i].filter(velocity[i]);
00618       } 
00619     
00620       <font class="keywordflow">for</font> (i = 0; i &lt; 6; i++) 
00621     {
00622         torque[i]+=  Kp[i]  * (qd[i] - jointAngles[i])
00623                              + Kd[i]  * (qddot[i] - velocity[i]) 
00624                              +  qddoubledot[i];
00625         
00626 
00627     
00628     }
00629 
00630     oldJointAngles[1][0] = oldJointAngles[0][0]; oldJointAngles[0][0] = jointAngles[0];
00631     oldJointAngles[1][1] = oldJointAngles[0][1]; oldJointAngles[0][1] = jointAngles[1];
00632     oldJointAngles[1][2] = oldJointAngles[0][2]; oldJointAngles[0][2] = jointAngles[2];
00633     oldJointAngles[1][3] = oldJointAngles[0][3]; oldJointAngles[0][3] = jointAngles[3];
00634     oldJointAngles[1][4] = oldJointAngles[0][4]; oldJointAngles[0][4] = jointAngles[4];
00635     oldJointAngles[1][5] = oldJointAngles[0][5]; oldJointAngles[0][5] = jointAngles[5];
00636                                         
00637 }
00638 
00639 
00640 
00641 <font class="keywordtype">void</font> PumaUtil::angleToEncoder( <font class="keywordtype">double</font> *theta, <font class="keywordtype">int</font> *EncValue )<font class="keyword"></font>
00642 <font class="keyword"></font>{
00643     <font class="keywordtype">int</font> i;
00644     <font class="keywordtype">double</font> dummyang, rawtheta5, rawtheta6 ;
00645     <font class="keywordtype">double</font>
00646             thetadeg0[6]= { 0, -90, 90, 0, 0, 0 };
00647 
00648          rawtheta5 = theta[4] + theta[3]*cfactor45;
00649          rawtheta6 = theta[5] + theta[3]*cfactor46 + theta[4]*cfactor56;
00650           <font class="keywordflow">for</font> (i=0;i&lt;6;i++)
00651          {
00652                 dummyang = theta[i];
00653             <font class="keywordflow">if</font> (i==4) dummyang = rawtheta5;
00654             <font class="keywordflow">else</font> <font class="keywordflow">if</font> (i==5) dummyang = rawtheta6;
00655             EncValue[i] =(<font class="keywordtype">int</font>)( floor(dummyang - thetadeg0[i]) * encoderCountPerDeg[i]);
00656      }
00657 }
00658 
00659 
00660 
00661 <font class="keywordtype">void</font> PumaUtil::encoderToRadians(<font class="keywordtype">int</font> * EncValue, <font class="keywordtype">double</font> *theta)<font class="keyword"></font>
00662 <font class="keyword"></font>{
00663     <font class="keywordtype">double</font> theta0[6] = { 0, -1.57079632, 1.57079632, 0, 0, 0 };
00664         
00665         <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i=0; i&lt;6; i++)
00666              theta[i] = ((<font class="keywordtype">double</font>)(EncValue[i]) / encoderCountPerRad[i]) + theta0[i];
00667 
00668          theta[5] = theta[5] - (theta[3] * cfactor46) - (theta[4] * cfactor56);
00669          theta[4] = theta[4] - (theta[3] * cfactor45);
00670 }
00671 
00672 
00673 
00674 <font class="keywordtype">int</font> PumaUtil::checkJointLimit(<font class="keywordtype">int</font> joint, <font class="keywordtype">double</font> JointAngle)<font class="keyword"></font>
00675 <font class="keyword"></font>{
00676       <font class="keywordflow">if</font> ( JointAngle &gt;= ((angleMax[joint]-5)*DEGTORAD) )
00677         <font class="keywordflow">return</font>(0);
00678 
00679       <font class="keywordflow">else</font> <font class="keywordflow">if</font> ( JointAngle &lt;= ((angleMin[joint]+5)*DEGTORAD) )
00680         <font class="keywordflow">return</font>(0);
00681 
00682        <font class="keywordflow">return</font>(1);
00683     
00684 }
00685 
00686 
00687 
00688 <font class="keywordtype">void</font> PumaUtil::setEncoderValues ( <font class="keywordtype">int</font> *encoderValues)<font class="keyword"></font>
00689 <font class="keyword"></font>{
00690     <font class="keywordtype">int</font> channel;
00691 
00692     <font class="keywordflow">for</font> ( channel = 0; channel&lt;6; channel ++)
00693     {
00694         d_ioBoardClient-&gt;setEncoderValue(channel, encoderValues[channel]);
00695     }
00696 }
00697 
00698     
00699 
00700 <font class="keywordtype">void</font> PumaUtil::setTorqueValues (<font class="keywordtype">double</font> *values)<font class="keyword"></font>
00701 <font class="keyword"></font>{
00702   <font class="keywordtype">int</font> channel;
00703   <font class="keywordtype">double</font> voltage;
00704   
00705     <font class="keywordflow">for</font> ( channel = 0; channel&lt;6; channel ++)
00706     {
00707         voltage = voltageScale[channel] * values[channel];
00708 
00709         <font class="keywordflow">if</font> (voltage &gt; 4.995) voltage = 4.995;
00710          <font class="keywordflow">else</font>
00711         <font class="keywordflow">if</font> (voltage &lt; -4.995) voltage = -4.995;
00712         
00713       d_ioBoardClient-&gt;setDacValue(channel, voltage);
00714     }
00715 
00716 }
00717 
00718 
00719 
00720 <font class="keywordtype">int</font> PumaUtil:: linearInterpolate( <font class="keywordtype">double</font> *slope, <font class="keywordtype">double</font> *intercept,
00721                                                                     <font class="keywordtype">double</font> *Xvector, <font class="keywordtype">double</font>  *Yvector,
00722                                                                     <font class="keywordtype">int</font> size)<font class="keyword"></font>
00723 <font class="keyword"></font>{
00724     <font class="keywordtype">double</font> sumX = 0.0;
00725     <font class="keywordtype">double</font> sumY = 0.0;
00726     <font class="keywordtype">double</font> sumXX = 0.0;
00727     <font class="keywordtype">double</font> sumXY = 0.0;
00728 
00729     <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; size; i++)
00730     {
00731         d_debugStream &lt;&lt; <font class="stringliteral">"Interpolate: X/Y = "</font>
00732                                     &lt;&lt; Xvector[i] &lt;&lt; <font class="stringliteral">", "</font> &lt;&lt; Yvector &lt;&lt; endl;
00733                                     
00734         sumX += Xvector[i]; sumY += Yvector[i];
00735         sumXX += Xvector[i] * Xvector[i];
00736         sumXY += Xvector[i] * Yvector[i];
00737     }
00738     
00739     <font class="keywordtype">double</font> denom = size * sumXX - sumX * sumX;
00740     <font class="keywordflow">if</font> (denom == 0.0)
00741         <font class="keywordflow">return</font> (-1);
00742         
00743     *slope = (size * sumXY - sumX * sumY ) / denom; 
00744     *intercept = (sumXX * sumY - sumX * sumXY) / denom;
00745 
00746     <font class="keywordflow">return</font>(0); 
00747 }
00748                                                                                     
00749 
00750 
00751 <font class="keywordtype">double</font> PumaUtil::maximum(<font class="keywordtype">double</font> *vector, <font class="keywordtype">int</font> size)<font class="keyword"></font>
00752 <font class="keyword"></font>{
00753     <font class="keywordtype">int</font> i;
00754     <font class="keywordtype">double</font> big;
00755     
00756     big = 0.001; 
00757     
00758     <font class="keywordflow">for</font> (i=0; i&lt;size; i++) 
00759     {
00760         big = (big &lt;fabs(vector[i]) ? fabs(vector[i]) : big); 
00761     } 
00762     <font class="keywordflow">return</font>(big);
00763 }
00764                                              
00765 
00766 
00767 <font class="keywordtype">int</font> PumaUtil::jointLevelTrajectoryGenerator(<font class="keywordtype">double</font> movementscale)<font class="keyword"></font>
00768 <font class="keyword"></font>{
00769     <font class="keywordtype">int</font> i;
00770     <font class="keywordtype">double</font>  t, maxvalue;
00771     <font class="keywordtype">double</font>  t5, t4, t3, t2;
00772                      
00773     maxvalue = maximum(delta, 6);
00774     <font class="comment">/* motion of all joints have to end at the same time */</font>
00775     t = (time - controlTimer) /(movementscale * maxvalue) ;
00776     
00777     <font class="keywordflow">if</font> (t&gt;= 1.12)
00778         <font class="keywordflow">return</font> (1);
00779     
00780     t2 = t*t; 
00781     t3 = t*t2;
00782     t4 = t*t3;
00783     t5 = t*t4;        
00784     
00785     <font class="keywordflow">for</font> (i=0; i&lt;6; i++)
00786     {
00787         <font class="keywordflow">if</font> (t &lt;= 1.0) 
00788         {
00789             qd[i]          = delta[i] * (6*t5 - 15*t4 + 10*t3) + DEGTORAD * initialAngles[i];
00790             qddot[i]       = delta[i] * (30*t4 - 60*t3 + 30*t2);
00791             qddoubledot[i] = delta[i]/maxvalue * (120*t3 - 180*t2 + 60*t);
00792         }
00793         <font class="keywordflow">else</font> 
00794         {
00795             qd[i]          = delta[i] + DEGTORAD * initialAngles[i];
00796             qddot[i]       = 0;
00797             qddoubledot[i] = 0;
00798         }
00799     }
00800     
00801         <font class="keywordflow">return</font>(0);
00802     
00803 }
00804 
00805     
00806 
00807 <font class="keywordtype">int</font> PumaUtil::readConfiguration()<font class="keyword"></font>
00808 <font class="keyword"></font>{
00809     d_config.setCurrentSectionName(<font class="stringliteral">"PumaUtil"</font>);
00810     d_config.enableAutoClearStatus();
00811     
00812     d_ioBoardServerName = d_config.getStringEntry(<font class="stringliteral">"ioBoardServerName"</font>,
00813                                                                                                 <font class="stringliteral">"qrts/iobs0"</font>);
00814     d_armPowerDigitalOutChannel =
00815         d_config.getIntegerEntry(<font class="stringliteral">"armPowerDigitalOutChannel"</font>, 16);
00816 
00817     d_armPowerDigitalOutValue =
00818         d_config.getIntegerEntry(<font class="stringliteral">"armPowerDigitalOutValue"</font>, 1);
00819 
00820     d_armPowerDigitalInChannel =
00821         d_config.getIntegerEntry(<font class="stringliteral">"armPowerDigitalInChannel"</font>, 6);
00822 
00823     d_armPowerDigitalInValue =
00824         d_config.getIntegerEntry(<font class="stringliteral">"armPowerDigitalInValue"</font>, 0);
00825 
00826     d_useDigitalInputsForIndexPulses =
00827         d_config.getIntegerEntry(<font class="stringliteral">"useDigitalInputsForIndexPulses"</font>, 0);
00828             
00829     <font class="keywordflow">return</font> 0;
00830 }
00831 
00832 
00833 
00834 <font class="keywordtype">void</font> PumaUtil::enableArmPower()<font class="keyword"></font>
00835 <font class="keyword"></font>{
00836         d_messageStream
00837         &lt;&lt; <font class="stringliteral">"------------------------------------------------"</font> &lt;&lt; endl
00838         &lt;&lt; <font class="stringliteral">" PLEASE ENABLE THE ARM POWER OF THE MANIPULATOR "</font> &lt;&lt; endl
00839         &lt;&lt; <font class="stringliteral">"------------------------------------------------"</font> &lt;&lt; endl;
00840   
00841     d_ioBoardClient-&gt;setDigoutBitValue(d_armPowerDigitalOutChannel,
00842         d_armPowerDigitalOutValue);
00843 }
00844 
00845 
00846 
00847 <font class="keywordtype">void</font> PumaUtil::disableArmPower()<font class="keyword"></font>
00848 <font class="keyword"></font>{
00849     d_ioBoardClient-&gt;setDigoutBitValue(d_armPowerDigitalOutChannel,
00850         1 - d_armPowerDigitalOutValue);
00851 }
00852 
00853 
00854 
00855 <font class="keywordtype">int</font> main (<font class="keywordtype">int</font> argc, <font class="keywordtype">char</font> *argv[])<font class="keyword"></font>
00856 <font class="keyword"></font>{
00857     PumaUtil *pumautil = <font class="keyword">new</font> PumaUtil (argc, argv);
00858     pumautil-&gt;run();
00859     <font class="keyword">delete</font> pumautil;
00860     
00861     <font class="keywordflow">return</font> 0;
00862 }
00863 
</div></pre></body>
</html>
